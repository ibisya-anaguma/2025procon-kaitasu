name: autocart-daily

on:
  schedule:
    - cron: "0 16 * * *"  # 毎日 01:00 JST
  workflow_dispatch: {}

concurrency:
  group: autocart-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run-autocart:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Cache node_modules for checkout job
        uses: actions/cache@v4
        with:
          path: src/jobs/checkout/node_modules
          key: ${{ runner.os }}-autocart-${{ hashFiles('src/jobs/checkout/package-lock.json', 'src/jobs/checkout/package.json') }}
          restore-keys: |
            ${{ runner.os }}-autocart-

      - name: Install dependencies (autocart)
        working-directory: src/jobs/checkout
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Write firebase credentials file (optional, safe)
        run: |
          set -euo pipefail
          if [ -n "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            printf '%s' "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > /tmp/firebase-service-account.json
            chmod 600 /tmp/firebase-service-account.json
            echo "/tmp/firebase-service-account.json written"
          else
            echo "FIREBASE_SERVICE_ACCOUNT not provided; proceeding without file"
          fi

      - name: Run autocart (TypeScript) via ts-node (no dist committed)
        working-directory: src/jobs/checkout
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          CART_API_KEY: ${{ secrets.CART_API_KEY }}
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/firebase-service-account.json
          TS_NODE_TRANSPILE_ONLY: "true"
        run: |
          set -euo pipefail
          echo "Node: $(node --version)"
          echo "Running ts-node: src/jobs/checkout/autocart-runner.ts (dry run)"
          # dry run for safety; remove --dry to actually write to Firestore
          npx ts-node --project ./tsconfig.json --transpile-only ./autocart-runner.ts --days 30 --dry

      - name: Upload logs/artifact (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: autocart-logs
          path: src/jobs/checkout/logs/**/*.log